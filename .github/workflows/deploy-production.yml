name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docs-website/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  VPS_SERVER: 78.138.17.185
  PRODUCTION_HOST: healthcare.hremsoftconsulting.com
  API_HOST: api.hremsoftconsulting.com

permissions:
  contents: read

jobs:
  # Deploy to VPS Production Server
  deploy:
    name: Deploy to VPS Server (78.138.17.185)
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://${{ env.PRODUCTION_HOST }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS server to known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || env.VPS_SERVER }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${SSH_HOST} >> ~/.ssh/known_hosts
          echo "‚úÖ Added VPS server to known hosts: ${SSH_HOST}"

      - name: Deploy to VPS server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || env.VPS_SERVER }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          VPS_IP: ${{ env.VPS_SERVER }}
        run: |
          echo "üöÄ Starting deployment to VPS server (${VPS_IP})..."
          echo "üìç Target VPS: ${SSH_HOST}"
          echo "üë§ SSH User: ${SSH_USER}"
          echo "üìÇ Deploy Path: ${DEPLOY_PATH}"
          
          # Create deployment script
          cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "=========================================="
          echo "üöÄ GitHub Actions Deployment to VPS"
          echo "üìç Server: ${VPS_IP:-78.138.17.185}"
          echo "=========================================="
          echo ""
          
          # Determine if sudo is needed for docker commands
          DOCKER_CMD="docker"
          DOCKER_COMPOSE_CMD="docker-compose"
          
          # Check if docker works without sudo
          if docker ps > /dev/null 2>&1; then
            echo "‚úÖ Docker can be run without sudo (user is in docker group)"
          else
            echo "‚ö†Ô∏è  Docker requires sudo, checking if passwordless sudo is configured..."
            
            # Test passwordless sudo (the -n flag means non-interactive, will fail if password needed)
            if sudo -n true 2>/dev/null && sudo -n docker ps > /dev/null 2>&1; then
              echo "‚úÖ Passwordless sudo is configured for docker"
              DOCKER_CMD="sudo docker"
              DOCKER_COMPOSE_CMD="sudo docker-compose"
            else
              echo ""
              echo "‚ùå ERROR: Docker commands require sudo but passwordless sudo is NOT configured"
              echo ""
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo "  ACTION REQUIRED: Configure Docker Permissions on VPS Server"
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo ""
              echo "SSH into your VPS server (78.138.17.185) and run ONE of these:"
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "  OPTION 1 (Recommended): Add user to docker group"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "  ssh your_username@78.138.17.185"
              echo "  sudo usermod -aG docker \$USER"
              echo "  newgrp docker"
              echo "  docker ps  # Test it works"
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "  OPTION 2: Configure passwordless sudo for docker"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "  ssh your_username@78.138.17.185"
              echo "  sudo visudo"
              echo "  # Add this line at the end (replace YOUR_USERNAME):"
              echo "  YOUR_USERNAME ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/local/bin/docker-compose, /usr/bin/docker-compose"
              echo "  # Save: Ctrl+X, Y, Enter"
              echo "  sudo -n docker ps  # Test it works"
              echo ""
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo "  After configuring, re-run this deployment workflow"
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo ""
              exit 1
            fi
          fi
          echo ""
          
          # Step 1: Navigate to project directory
          echo "üìÇ Step 1: Navigating to project directory..."
          cd ${DEPLOY_PATH:-~/healthcare-app}
          pwd
          echo ""
          
          # Step 2: Pull latest code
          echo "üì• Step 2: Pulling latest code from GitHub..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          echo "‚úÖ Code updated"
          echo ""
          
          # Step 3: Stop existing containers (graceful)
          echo "üõë Step 3: Stopping existing containers..."
          ${DOCKER_COMPOSE_CMD} down || true
          echo "‚úÖ Containers stopped"
          echo ""
          
          # Step 4: Build containers
          echo "üèóÔ∏è  Step 4: Building containers..."
          ${DOCKER_COMPOSE_CMD} build --no-cache
          echo "‚úÖ Containers built"
          echo ""
          
          # Step 5: Start services
          echo "üöÄ Step 5: Starting services..."
          ${DOCKER_COMPOSE_CMD} up -d
          echo "‚úÖ Services started"
          echo ""
          
          # Step 6: Wait for database to be ready
          echo "‚è≥ Step 6: Waiting for database to be ready..."
          for i in {1..30}; do
            if ${DOCKER_CMD} exec healthcare_db pg_isready -U postgres > /dev/null 2>&1; then
              echo "‚úÖ Database is ready"
              break
            fi
            echo "   Waiting... ($i/30)"
            sleep 2
          done
          echo ""
          
          # Step 7: Run database migrations
          echo "üóÑÔ∏è  Step 7: Running database migrations..."
          if [ -f "backend/migrations/001_multi_tenancy.sql" ]; then
            ${DOCKER_CMD} exec -i healthcare_db psql -U postgres -d healthcare < backend/migrations/001_multi_tenancy.sql 2>/dev/null || echo "‚ö†Ô∏è  Migration 001 already applied or skipped"
          fi
          
          if [ -f "backend/migrations/002_add_discord_webhook.sql" ]; then
            ${DOCKER_CMD} exec -i healthcare_db psql -U postgres -d healthcare < backend/migrations/002_add_discord_webhook.sql 2>/dev/null || echo "‚ö†Ô∏è  Migration 002 already applied or skipped"
          fi
          echo "‚úÖ Migrations completed"
          echo ""
          
          # Step 8: Wait for backend to start
          echo "‚è≥ Step 8: Waiting for backend to initialize..."
          sleep 15
          echo ""
          
          # Step 9: Check service status
          echo "üìä Step 9: Checking service status..."
          ${DOCKER_COMPOSE_CMD} ps
          echo ""
          
          # Step 10: Check backend logs
          echo "üìã Step 10: Backend logs (last 20 lines)..."
          ${DOCKER_COMPOSE_CMD} logs --tail=20 backend
          echo ""
          
          # Step 11: Test endpoints
          echo "üß™ Step 11: Testing endpoints..."
          echo ""
          echo "Testing frontend:"
          curl -s -o /dev/null -w "Status: %{http_code}\n" https://${PRODUCTION_HOST} || echo "‚ö†Ô∏è  Frontend check skipped"
          echo ""
          echo "Testing API:"
          curl -s -o /dev/null -w "Status: %{http_code}\n" https://${API_HOST}/docs || echo "‚ö†Ô∏è  API check skipped"
          echo ""
          echo "Testing docs-website:"
          curl -s -o /dev/null -w "Status: %{http_code}\n" https://${API_HOST}/docs-website/ || echo "‚ö†Ô∏è  Docs check skipped"
          echo ""
          
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo "=========================================="
          echo ""
          echo "üîó URLs:"
          echo "   Frontend: https://${PRODUCTION_HOST}"
          echo "   API:      https://${API_HOST}"
          echo "   Docs:     https://${API_HOST}/docs-website/"
          echo "   Swagger:  https://${API_HOST}/docs"
          echo ""
          DEPLOY_SCRIPT
          
          # Copy and execute deployment script on VPS
          echo "üì§ Copying deployment script to VPS..."
          scp /tmp/deploy.sh ${SSH_USER}@${SSH_HOST}:/tmp/deploy.sh
          echo "‚ñ∂Ô∏è  Executing deployment on VPS..."
          ssh ${SSH_USER}@${SSH_HOST} "chmod +x /tmp/deploy.sh && DEPLOY_PATH=${DEPLOY_PATH} PRODUCTION_HOST=${PRODUCTION_HOST} API_HOST=${API_HOST} VPS_IP=${VPS_IP} /tmp/deploy.sh"

      - name: Verify VPS deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || env.VPS_SERVER }}
          SSH_USER: ${{ secrets.SSH_USER }}
          VPS_IP: ${{ env.VPS_SERVER }}
        run: |
          echo "üîç Verifying deployment on VPS (${VPS_IP})..."
          
          # Test endpoints
          echo "Testing production endpoints..."
          
          # Test frontend
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.PRODUCTION_HOST }} || echo "000")
          if [ "$FRONTEND_STATUS" = "200" ] || [ "$FRONTEND_STATUS" = "301" ] || [ "$FRONTEND_STATUS" = "302" ]; then
            echo "‚úÖ Frontend is accessible (Status: $FRONTEND_STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend returned status: $FRONTEND_STATUS"
          fi
          
          # Test API
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.API_HOST }}/docs || echo "000")
          if [ "$API_STATUS" = "200" ]; then
            echo "‚úÖ API is accessible (Status: $API_STATUS)"
          else
            echo "‚ö†Ô∏è  API returned status: $API_STATUS"
          fi
          
          # Test docs-website
          DOCS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.API_HOST }}/docs-website/ || echo "000")
          if [ "$DOCS_STATUS" = "200" ]; then
            echo "‚úÖ Docs website is accessible (Status: $DOCS_STATUS)"
          else
            echo "‚ö†Ô∏è  Docs website returned status: $DOCS_STATUS"
          fi
          
          echo ""
          echo "üéâ Deployment verification complete!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for details."
          # You can add Slack/Discord webhook notification here
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"üö® Deployment to production failed!"}' \
          #   ${{ secrets.DISCORD_WEBHOOK_URL }}

